import{as as J,q as j,cf as q,U as B,bx as u,y as w,hq as K,bc as Q,cc as Z,hr as $,hs as U,au as E,aw as ee,hj as te,ht as ae,hu as ie,ho as re,b8 as se}from"./index.1aec8a9e.js";import{Y as ne,s as oe}from"./cimAnalyzer.5b8004f5.js";import{f as ce,s as le}from"./CIMSymbolHelper.5061c0e8.js";import{m as me}from"./Rasterizer.c7e966e8.js";import"./definitions.cd8c5521.js";import"./quantizationUtils.00334c11.js";import"./Rect.a122c453.js";import"./alignmentUtils.84250e5d.js";import"./number.6e30c64a.js";import"./GeometryUtils.f3664fe1.js";var F;(function(m){m.Legend="legend",m.Preview="preview"})(F||(F={}));const D=(m,e,t)=>{if(m&&m.targetSize){let s;if(t){const i=Math.max(t.frame.xmax-t.frame.xmin,t.frame.ymax-t.frame.ymin);s=m.targetSize/w(i)}else s=m.targetSize/e.referenceSize;return s}return m&&m.scaleFactor?m.scaleFactor:1},N={fill:{legend:{frame:{xmax:15,xmin:0,ymax:15,ymin:0},geometry:{rings:[[[0,15],[15,7.5],[15,0],[0,0],[0,15]]]},canvasPaths:{rings:[[[0,15],[0,0],[15,7.5],[15,15],[0,15]]]}},preview:{frame:{xmax:100,xmin:0,ymax:100,ymin:0},geometry:{rings:[[[0,100],[100,100],[100,0],[0,0],[0,100]]]},canvasPaths:{rings:[[[0,100],[0,0],[100,0],[100,100],[0,100]]]}}},stroke:{legend:{frame:{xmax:24,xmin:0,ymax:2,ymin:-2},geometry:{paths:[[[0,0],[12,0],[24,0]]]},canvasPaths:{paths:[[[0,2],[12,2],[24,2]]]}},preview:{frame:{xmax:100,xmin:0,ymax:2,ymin:-2},geometry:{paths:[[[0,0],[50,0],[100,0]]]},canvasPaths:{paths:[[[0,2],[50,2],[100,2]]]}}}};class he{constructor(e,t){this._spatialReference=e,this._avoidSDF=t,this._resourceCache=new Map,this._pictureMarkerCache=new Map,this._textRasterizer=new ce,this._cimResourceManager=new le,this._rasterizer=new me(this._cimResourceManager)}async rasterizeCIMSymbolAsync(e,t,s,i,a,r,o,n){i=i||(t?t.centroid!=null?"esriGeometryPolygon":J(t.geometry):null)||ge(e);const c=await this.analyzeCIMSymbol(e,t?fe(t.attributes):null,s,i,n);return this.rasterizeCIMSymbol(c,t,i,a,r,o)}async analyzeCIMSymbol(e,t,s,i,a){const r=[],o=t?{geometryType:i,spatialReference:this._spatialReference,fields:t}:null;let n;await ne(e.data,o,this._cimResourceManager,r,this._avoidSDF),j(a);for(const c of r)c.cim.type!=="CIMPictureMarker"&&c.cim.type!=="CIMPictureFill"&&c.cim.type!=="CIMPictureStroke"||(n||(n=[]),n.push(this._fetchPictureMarkerResource(c,a))),s&&c.type==="text"&&typeof c.text=="string"&&c.text.includes("[")&&(c.text=q(s,c.text,c.cim.textCase));return n&&await Promise.all(n),r}async _fetchPictureMarkerResource(e,t){const s=e.materialHash;if(!this._pictureMarkerCache.get(s)){const i=(await B(e.cim.url,{responseType:"image",signal:t&&t.signal})).data;this._pictureMarkerCache.set(s,i)}}rasterizeCIMSymbol(e,t,s,i,a,r){const o=[];for(const n of e){i&&typeof i.scaleFactor=="function"&&(i.scaleFactor=i.scaleFactor(t,a,r));const c=this._getRasterizedResource(n,t,s,i,a,r);if(!c)continue;let M=0,z=c.anchorX||0,p=c.anchorY||0,l=!1,g=0,f=0;if(s==="esriGeometryPoint"){const h=D(i,n,null);if(g=u(n.offsetX,t,a,r)*h||0,f=u(n.offsetY,t,a,r)*h||0,n.type==="marker")M=u(n.rotation,t,a,r)||0,l=!!n.rotateClockwise&&n.rotateClockwise;else if(n.type==="text"){if(M=u(n.angle,t,a,r)||0,n.horizontalAlignment!==void 0)switch(n.horizontalAlignment){case"left":z=-.5;break;case"right":z=.5;break;default:z=0}if(n.verticalAlignment!==void 0)switch(n.verticalAlignment){case"top":p=.5;break;case"bottom":p=-.5;break;case"baseline":p=-.25;break;default:p=0}}}c!=null&&o.push({angle:M,rotateClockWise:l,anchorX:z,anchorY:p,offsetX:g,offsetY:f,rasterizedResource:c})}return this.getSymbolImage(o)}getSymbolImage(e){const t=document.createElement("canvas"),s=t.getContext("2d");let i=0,a=0,r=0,o=0;const n=[];for(let p=0;p<e.length;p++){const l=e[p],g=l.rasterizedResource;if(!g)continue;const f=g.size,h=l.offsetX,y=l.offsetY,d=l.anchorX,C=l.anchorY,I=l.rotateClockWise||!1;let x=l.angle,P=w(h)-f[0]*(.5+d),_=w(y)-f[1]*(.5+C),k=P+f[0],S=_+f[1];if(x){I&&(x=-x);const b=Math.sin(x*Math.PI/180),v=Math.cos(x*Math.PI/180),T=P*v-_*b,Y=P*b+_*v,X=P*v-S*b,O=P*b+S*v,G=k*v-S*b,L=k*b+S*v,V=k*v-_*b,H=k*b+_*v;P=Math.min(T,X,G,V),_=Math.min(Y,O,L,H),k=Math.max(T,X,G,V),S=Math.max(Y,O,L,H)}i=P<i?P:i,a=_<a?_:a,r=k>r?k:r,o=S>o?S:o;const A=s.createImageData(g.size[0],g.size[1]);A.data.set(new Uint8ClampedArray(g.image.buffer));const W={offsetX:h,offsetY:y,rotateClockwise:I,angle:x,rasterizedImage:A,anchorX:d,anchorY:C};n.push(W)}t.width=r-i,t.height=o-a;const c=-i,M=o;for(let p=0;p<n.length;p++){const l=n[p],g=this._imageDataToCanvas(l.rasterizedImage),f=l.rasterizedImage.width,h=l.rasterizedImage.height,y=c-f*(.5+l.anchorX),d=M-h*(.5-l.anchorY);if(l.angle){const C=(360-l.angle)*Math.PI/180;s.save(),s.translate(w(l.offsetX),-w(l.offsetY)),s.translate(c,M),s.rotate(C),s.translate(-c,-M),s.drawImage(g,y,d),s.restore()}else s.drawImage(g,y+w(l.offsetX),d-w(l.offsetY))}const z=new K({x:c/t.width-.5,y:M/t.height-.5});return{imageData:t.width!==0&&t.height!==0?s.getImageData(0,0,t.width,t.height):s.createImageData(1,1),anchorPosition:z}}_imageDataToCanvas(e){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const t=this._imageDataCanvas,s=t.getContext("2d");return t.width=e.width,t.height=e.height,s.putImageData(e,0,0),t}_imageTo32Array(e,t,s,i){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const a=this._imageDataCanvas,r=a.getContext("2d");if(a.width=t,a.height=s,r.drawImage(e,0,0,t,s),i){r.save();const o=new Q(i);r.fillStyle=o.toHex(),r.globalCompositeOperation="multiply",r.fillRect(0,0,t,s),r.globalCompositeOperation="destination-atop",r.drawImage(e,0,0,t,s),r.restore()}return new Uint32Array(r.getImageData(0,0,t,s).data.buffer)}_getRasterizedResource(e,t,s,i,a,r){let o,n,c,M,z=null,p=null;if(s==="esriGeometryPolyline"||s==="esriGeometryPolygon"){const g=i&&i.style?i.style:F.Legend,f=s==="esriGeometryPolyline"?N.stroke[g]:N.fill[g];if(e.type==="line"){if(e.cim.type!=="CIMSolidStroke"){if(e.cim.type==="CIMPictureStroke"){const h=u(e.width,t,a,r),y=u(e.color,t,a,r),{image:d,width:C,height:I}=this._getPictureResource(e,h,y);return this._rasterizePictureResource(e,d,C,I,f,h)}return null}({analyzedCIM:o,hash:c}=R(e,t,a,r)),n=this._embedCIMLayerInVectorMarker(o,f)}else if(e.type==="marker"){if(e.cim.type==="CIMPictureMarker"){const h=u(e.size,t,a,r),y=u(e.color,t,a,r),{image:d,width:C,height:I}=this._getPictureResource(e,h,y);return this._rasterizePictureResource(e,d,C,I,f,h)}if(e.cim.type!=="CIMVectorMarker")return null;e.cim.offsetX=u(e.offsetX,t,a,r),e.cim.offsetY=u(e.offsetY,t,a,r),e.cim.rotation=u(e.rotation,t,a,r),e.cim.markerPlacement=e.markerPlacement,{analyzedCIM:o}=R(e,t,a,r),c=Z(JSON.stringify(o)).toString(),n=this._embedCIMLayerInVectorMarker(o,f),z=u(e.size,t,a,r),p=e.path}else{if(e.type==="text")return null;if(e.type==="fill"){if(e.cim.type==="CIMHatchFill"||e.cim.type==="CIMVectorMarker"||e.cim.type==="CIMPictureMarker"||e.cim.type==="CIMPictureFill"){const h=e.cim.size||e.cim.height;let y,d,C;if(e.cim.type==="CIMPictureMarker"||e.cim.type==="CIMPictureFill")({image:y,width:d,height:C}=this._getPictureResource(e,h,u(e.color,t,a,r)));else{({analyzedCIM:o,hash:c}=R(e,t,a,r));const I=this._rasterizer.rasterizeJSONResource({cim:o,type:e.type,url:e.url,mosaicHash:c,size:h,path:p},1,this._avoidSDF);y=I.image,d=I.size[0],C=I.size[1]}return this._rasterizePictureResource(e,y,d,C,f,null)}if(e.cim.type!=="CIMSolidFill")return null;({analyzedCIM:o,hash:c}=R(e,t,a,r)),n=this._embedCIMLayerInVectorMarker(o,f)}}}else{if(e.type==="text")return M=this._rasterizeTextResource(e,t,i,a,r),M;({analyzedCIM:o,hash:c}=R(e,t,a,r));const g=D(i,e,null);if(e.cim.type==="CIMPictureMarker"){const f=u(e.size,t,a,r)*g,{image:h,width:y,height:d}=this._getPictureResource(e,f,u(e.color,t,a,r));return M={image:h,size:[y,d],sdf:!1,simplePattern:!1,anchorX:e.anchorPoint?e.anchorPoint.x:0,anchorY:e.anchorPoint?e.anchorPoint.y:0},M}$(o,g,{preserveOutlineWidth:!1}),n=o}c+=s,i&&(c+=JSON.stringify(i));const l=this._resourceCache;return l.has(c)?l.get(c):(M=this._rasterizer.rasterizeJSONResource({cim:n,type:e.type,url:e.url,mosaicHash:c,size:z,path:p},window.devicePixelRatio||1,this._avoidSDF),l.set(c,M),M)}_rasterizeTextResource(e,t,s,i,a){const r=D(s,e,null),o=u(e.text,t,i,a);if(!o||o.length===0)return null;const n=u(e.fontName,t,i,a),c=u(e.style,t,i,a),M=u(e.weight,t,i,a),z=u(e.decoration,t,i,a),p=u(e.size,t,i,a)*r,l=u(e.horizontalAlignment,t,i,a),g=u(e.verticalAlignment,t,i,a),f=U(u(e.color,t,i,a)),h=U(u(e.outlineColor,t,i,a)),y={color:f,size:p,horizontalAlignment:l,verticalAlignment:g,font:{family:n,style:c,weight:M,decoration:z},halo:{size:u(e.outlineSize,t,i,a)||0,color:h,style:c},pixelRatio:1,premultiplyColors:!this._avoidSDF};return this._textRasterizer.rasterizeText(o,y)}_rasterizePictureResource(e,t,s,i,a,r){const o=document.createElement("canvas"),n=o.getContext("2d");o.height=w(Math.max(a.frame.ymax-a.frame.ymin,r)),o.width=w(a.frame.xmax-a.frame.xmin);const c=n.createImageData(s,i);c.data.set(new Uint8ClampedArray(t.buffer));const M=this._imageDataToCanvas(c),z=n.createPattern(M,"repeat"),p=Math.cos((-e.cim.rotation||0)*Math.PI/180),l=Math.sin((-e.cim.rotation||0)*Math.PI/180);z.setTransform({m11:p,m12:l,m21:-l,m22:p,m41:w(e.cim.offsetX)||0,m42:w(e.cim.offsetY)||0});const g=a.canvasPaths;let f,h,y;E(g)?(f=g.rings,n.fillStyle=z,h=n.fill,y=["evenodd"]):ee(g)&&(f=g.paths,n.strokeStyle=z,n.lineWidth=r,h=n.stroke,f[0][0][1]=o.height/2,f[0][1][1]=o.height/2),n.beginPath();for(const I of f){const x=I?I.length:0;if(x>1){let P=I[0];n.moveTo(w(P[0]),w(P[1]));for(let _=1;_<x;++_)P=I[_],n.lineTo(w(P[0]),w(P[1]));n.closePath()}}h.apply(n,y);const d=n.getImageData(0,0,o.width,o.height),C=new Uint8Array(d.data);return{size:[o.width,o.height],image:new Uint32Array(C.buffer),sdf:!1,simplePattern:!1,anchorX:0,anchorY:0}}_getPictureResource(e,t,s){const i=this._pictureMarkerCache.get(e.materialHash);if(!i)return null;const a=i.height/i.width,r=t?a>1?w(t):w(t)/a:i.width,o=t?a>1?w(t)*a:w(t):i.height;return{image:this._imageTo32Array(i,r,o,s),width:r,height:o}}_embedCIMLayerInVectorMarker(e,t){const s=E(t.geometry)?"CIMPolygonSymbol":"CIMLineSymbol",i=t.frame;return{type:"CIMVectorMarker",frame:i,size:i.ymax-i.ymin,markerGraphics:[{type:"CIMMarkerGraphic",geometry:t.geometry,symbol:{type:s,symbolLayers:[e]}}]}}}function fe(m){return(m?Object.keys(m):[]).map(e=>({name:e,alias:e,type:typeof m[e]=="string"?"esriFieldTypeString":"esriFieldTypeDouble"}))}function ge(m){if(!(m&&m.data&&m.data.symbol))return null;switch(m.data.symbol.type){case"CIMPointSymbol":case"CIMTextSymbol":return"esriGeometryPoint";case"CIMLineSymbol":return"esriGeometryPolyline";case"CIMPolygonSymbol":return"esriGeometryPolygon";default:return null}}function R(m,e,t,s){let i,a;return typeof m.materialHash=="function"?(i=(0,m.materialHash)(e,t,s),a=oe(m.cim,m.materialOverrides)):(i=m.materialHash,a=m.cim),{analyzedCIM:a,hash:i}}const ye=new he(null,!0),ue=te.maxSize;async function be(m,e={}){const{size:t,maxSize:s,node:i,opacity:a}=e,r=e.cimOptions||e,{feature:o,fieldMap:n,geometryType:c,style:M}=r,z=ae(m),p=typeof t=="number"?t:null,l=Math.min(p!=null?p:z,s!=null?s:se(ue));l!==z&&(m=m.clone(),ie(m,l,{preserveOutlineWidth:!0}));let g=3;m&&m.data&&m.data.symbol&&m.data.symbol.type!=="CIMPointSymbol"&&(g=1);const f=await ye.rasterizeCIMSymbolAsync(m,o,n,c,{scaleFactor:g,style:M}),h=document.createElement("canvas");h.width=f.imageData.width,h.height=f.imageData.height,h.getContext("2d").putImageData(f.imageData,0,0);let y=h.width/g,d=h.height/g;if(t!=null&&((e==null?void 0:e.scale)==null||(e==null?void 0:e.scale))){const x=y/d;y=x<=1?Math.ceil(l*x):l,d=x<=1?l:Math.ceil(l/x)}const C=new Image(y,d);C.src=h.toDataURL(),a!=null&&(C.style.opacity=`${a}`);let I=C;if(e.effectView!=null){const x={shape:{type:"image",x:0,y:0,width:y,height:d,src:C.src},fill:null,stroke:null,offset:[0,0]};I=re([[x]],[y,d],{effectView:e.effectView})}return i&&i.appendChild(I),I}export{be as previewCIMSymbol};
