import{aP as Le,aw as pe,au as ye,s as ne,f as $e,cc as P,cd as z,b7 as C,r as F,ce as Ie,cf as Xe,bx as Ce,y as Ae,cg as V,aY as ae,ch as ze,ci as Re,bN as Je,bc as He,b8 as Ye}from"./index.b0b4c8ac.js";import{o as Fe,t as Ee,a as Te,A as he,x as Ge,c as ge,Z as R,d as j}from"./CIMSymbolHelper.799bd5e9.js";import{H as re,x as ee,D as te,s as We}from"./definitions.cd8c5521.js";import{q as De,C as Ue,B as je,v as Be}from"./quantizationUtils.fc2d393d.js";function qe(e){var o;if(!e)return null;switch(e.type){case"CIMPointSymbol":{const t=e.symbolLayers;return t&&t.length===1?qe(t[0]):null}case"CIMVectorMarker":{const t=e.markerGraphics;if(!t||t.length!==1)return null;const r=t[0];if(!r)return null;const i=r.geometry;if(!i)return null;const n=r.symbol;return!n||n.type!=="CIMPolygonSymbol"&&n.type!=="CIMLineSymbol"||((o=n.symbolLayers)==null?void 0:o.some(l=>!!l.effects))?null:{geom:i,asFill:n.type==="CIMPolygonSymbol"}}case"sdf":return{geom:e.geom,asFill:e.asFill}}return null}function Ve(e){return e?e.rings?e.rings:e.paths?e.paths:e.xmin!==void 0&&e.ymin!==void 0&&e.xmax!==void 0&&e.ymax!==void 0?[[[e.xmin,e.ymin],[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin]]]:null:null}function Ze(e){let o=1/0,t=-1/0,r=1/0,i=-1/0;for(const n of e)for(const l of n)l[0]<o&&(o=l[0]),l[0]>t&&(t=l[0]),l[1]<r&&(r=l[1]),l[1]>i&&(i=l[1]);return new Ee(o,r,t-o,i-r)}function de(e){let o=1/0,t=-1/0,r=1/0,i=-1/0;for(const n of e)for(const l of n)l[0]<o&&(o=l[0]),l[0]>t&&(t=l[0]),l[1]<r&&(r=l[1]),l[1]>i&&(i=l[1]);return[o,r,t,i]}function Oe(e){return e?e.rings?de(e.rings):e.paths?de(e.paths):Le(e)?[e.xmin,e.ymin,e.xmax,e.ymax]:null:null}function ke(e,o,t,r,i){const[n,l,a,s]=e;if(a<n||s<l)return[0,0,0];const c=a-n,f=s-l,p=128,m=1,u=Math.floor(.5*(.5*p-m)),h=(p-2*(u+m))/Math.max(c,f),y=Math.round(c*h)+2*u,d=Math.round(f*h)+2*u;let S=1;o&&(S=d/h/(o.ymax-o.ymin));let N=0,b=0;if(r)if(i){if(o&&t&&o.ymax-o.ymin>0){const v=(o.xmax-o.xmin)/(o.ymax-o.ymin);N=r.x/(t*v),b=r.y/t}}else N=r.x,b=r.y;return N=.5*(o.xmax+o.xmin)+N*(o.xmax-o.xmin),b=.5*(o.ymax+o.ymin)+b*(o.ymax-o.ymin),N-=n,b-=l,N*=h,b*=h,N+=u,b+=u,[S,N/y-.5,-(b/d-.5)]}function Rt(e){const o=Ve(e.geom),t=Ze(o),r=128,i=1,n=Math.floor(.5*(.5*r-i)),l=(r-2*(n+i))/Math.max(t.width,t.height),a=Math.round(t.width*l)+2*n,s=Math.round(t.height*l)+2*n,c=[];for(const p of o)if(p&&p.length>1){const m=[];for(const u of p){let[h,y]=u;h-=t.x,y-=t.y,h*=l,y*=l,h+=n-.5,y+=n-.5,e.asFill?m.push([h,y]):m.push([Math.round(h),Math.round(y)])}if(e.asFill){const u=m.length-1;m[0][0]===m[u][0]&&m[0][1]===m[u][1]||m.push(m[0])}c.push(m)}const f=Ke(c,a,s,n);return e.asFill&&Qe(c,a,s,n,f),[_e(f,n),a,s]}function Ke(e,o,t,r){const i=o*t,n=new Array(i),l=r*r+1;for(let a=0;a<i;++a)n[a]=l;for(const a of e){const s=a.length;for(let c=1;c<s;++c){const f=a[c-1],p=a[c];let m,u,h,y;f[0]<p[0]?(m=f[0],u=p[0]):(m=p[0],u=f[0]),f[1]<p[1]?(h=f[1],y=p[1]):(h=p[1],y=f[1]);let d=Math.floor(m)-r,S=Math.floor(u)+r,N=Math.floor(h)-r,b=Math.floor(y)+r;d<0&&(d=0),S>o&&(S=o),N<0&&(N=0),b>t&&(b=t);const v=p[0]-f[0],k=p[1]-f[1],X=v*v+k*k;for(let x=d;x<S;x++)for(let $=N;$<b;$++){let w,O,M=(x-f[0])*v+($-f[1])*k;M<0?(w=f[0],O=f[1]):M>X?(w=p[0],O=p[1]):(M/=X,w=f[0]+M*v,O=f[1]+M*k);const L=(x-w)*(x-w)+($-O)*($-O),J=(t-$-1)*o+x;L<n[J]&&(n[J]=L)}}}for(let a=0;a<i;++a)n[a]=Math.sqrt(n[a]);return n}function Qe(e,o,t,r,i){for(const n of e){const l=n.length;for(let a=1;a<l;++a){const s=n[a-1],c=n[a];let f,p,m,u;s[0]<c[0]?(f=s[0],p=c[0]):(f=c[0],p=s[0]),s[1]<c[1]?(m=s[1],u=c[1]):(m=c[1],u=s[1]);let h=Math.floor(f),y=Math.floor(p)+1,d=Math.floor(m),S=Math.floor(u)+1;h<r&&(h=r),y>o-r&&(y=o-r),d<r&&(d=r),S>t-r&&(S=t-r);for(let N=d;N<S;++N){if(s[1]>N==c[1]>N)continue;const b=(t-N-1)*o;for(let v=h;v<y;++v)v<(c[0]-s[0])*(N-s[1])/(c[1]-s[1])+s[0]&&(i[b+v]=-i[b+v]);for(let v=r;v<h;++v)i[b+v]=-i[b+v]}}}}function _e(e,o){const t=2*o,r=e.length,i=new Uint8Array(4*r);for(let n=0;n<r;++n){const l=.5-e[n]/t;Fe(l,i,4*n)}return i}const et=96/72;class Se{static executeEffects(o,t,r){const i=Te(t),n=et;let l=new ge(i);for(const a of o){const s=he(a);s&&(l=s.execute(l,a,n,r))}return l}static next(o){const t=o.next();return Ge(t),t}static applyEffects(o,t,r){if(!o)return t;let i=new ge(t);for(const a of o){const s=he(a);s&&(i=s.execute(i,a,1,r))}let n,l=null;for(;n=i.next();)l?pe(l)?pe(n)&&l.paths.push(...n.paths):ye(l)&&ye(n)&&l.rings.push(...n.rings):l=n;return l}}function Z(e,o,t,r,i){const n=e.referencesGeometry()&&i?tt(o,r,i):o,l=e.repurposeFeature(n);try{return e.evaluate({...t,$feature:l})}catch(a){return ne.getLogger("esri.views.2d.support.arcadeOnDemand").warn("Feature arcade evaluation failed:",a),null}}const oe=new Map;function tt(e,o,t){const{transform:r,hasZ:i,hasM:n}=t;oe.has(o)||oe.set(o,ot(o));const l=oe.get(o)(e.geometry,r,i,n);return{...e,geometry:l}}function ot(e){const o={};switch(e){case"esriGeometryPoint":return(t,r,i,n)=>Be(r,o,t,i,n);case"esriGeometryPolygon":return(t,r,i,n)=>je(r,o,t,i,n);case"esriGeometryPolyline":return(t,r,i,n)=>Ue(r,o,t,i,n);case"esriGeometryMultipoint":return(t,r,i,n)=>De(r,o,t,i,n);default:return ne.getLogger("esri.views.2d.support.arcadeOnDemand").error(new $e("mapview-arcade",`Unable to handle geometryType: ${e}`)),t=>t}}function Me(e){const o=e.toLowerCase().split(" ").join("-");switch(o){case"serif":return"noto-serif";case"sans-serif":return"arial-unicode-ms";case"monospace":return"ubuntu-mono";case"fantasy":return"cabin-sketch";case"cursive":return"redressed";default:return o}}function Jt(e){const o=it(e)+rt(e);return Me(e.family)+(o.length>0?o:"-regular")}function it(e){if(!e.weight)return"";switch(e.weight.toLowerCase()){case"bold":case"bolder":return"-bold"}return""}function rt(e){if(!e.style)return"";switch(e.style.toLowerCase()){case"italic":case"oblique":return"-italic"}return""}function nt(e,o){let t;if(typeof e=="string")t=P(e+`-seed(${o})`);else{let r=12;t=e^o;do t=107*(t>>8^t)+r|0;while(--r!=0)}return(1+t/(1<<31))/2}function at(e){return Math.floor(nt(e,lt)*st)}const lt=53290320,st=10,le=ne.getLogger("esri.symbols.cim.cimAnalyzer");function se(e){switch(e){case"Butt":return ee.BUTT;case"Square":return ee.SQUARE;default:return ee.ROUND}}function ce(e){switch(e){case"Bevel":return te.BEVEL;case"Miter":return te.MITER;default:return te.ROUND}}function ct(e){switch(e){case"Left":default:return"left";case"Right":return"right";case"Center":return"center";case"Justify":return le.warnOnce("Horizontal alignment 'justify' is not implemented. Falling back to 'center'."),"center"}}function ft(e){switch(e){case"Top":default:return"top";case"Center":return"middle";case"Baseline":return"baseline";case"Bottom":return"bottom"}}function mt(e){let o="",t="";if(e){const r=e.toLowerCase();r.includes("italic")?o="italic":r.includes("oblique")&&(o="oblique"),r.includes("bold")?t="bold":r.includes("light")&&(t="lighter")}return{style:o,weight:t}}function ut(e){return e.underline?"underline":e.strikethrough?"line-through":"none"}function ve(e,o,t,r){let i;e[o]?i=e[o]:(i={},e[o]=i),i[t]=r}function be(e){const o=e.markerPlacement;return o&&o.angleToLine?re.MAP:re.SCREEN}async function Ht(e,o,t,r,i){const n=r!=null?r:[];if(!e)return n;let l,a;const s={};if(e.type!=="CIMSymbolReference")return le.error("Expect cim type to be 'CIMSymbolReference'"),n;if(l=e.symbol,a=e.primitiveOverrides,a){const f=[];for(const p of a){const m=p.valueExpressionInfo;if(m&&o){const u=m.expression,h=Je(u,o.spatialReference,o.fields).then(y=>{y&&ve(s,p.primitiveName,p.propertyName,y)});f.push(h)}else p.value!=null&&ve(s,p.primitiveName,p.propertyName,p.value)}f.length>0&&await Promise.all(f)}const c=[];switch(xe(l,t,c),c.length>0&&await Promise.all(c),l.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":pt(l,a,s,o,n,t,i)}return n}function pt(e,o,t,r,i,n,l){if(!e)return;const a=e.symbolLayers;if(!a)return;const s=e.effects;let c;const f=R.getSize(e);e.type==="CIMPointSymbol"&&e.angleAlignment==="Map"&&(c=re.MAP);let p=a.length;for(;p--;){const m=a[p];if(!m||m.enable===!1)continue;let u;s&&s.length&&(u=[...s]);const h=m.effects;h&&h.length&&(s?u.push(...h):u=[...h]);const y=[];let d;j.findEffectOverrides(u,o,y),d=y.length>0?xt(u,y,t,r):u;const S=[];switch(j.findApplicableOverrides(m,o,S),m.type){case"CIMSolidFill":yt(m,d,t,S,r,i);break;case"CIMPictureFill":ht(m,d,t,S,r,n,i);break;case"CIMHatchFill":gt(m,d,t,S,r,i);break;case"CIMGradientFill":dt(m,d,t,S,r,i);break;case"CIMSolidStroke":St(m,d,t,S,r,i,e.type==="CIMPolygonSymbol",f);break;case"CIMPictureStroke":vt(m,d,t,S,r,i,e.type==="CIMPolygonSymbol",f);break;case"CIMGradientStroke":bt(m,d,t,S,r,i,e.type==="CIMPolygonSymbol",f);break;case"CIMCharacterMarker":if(ie(m,d,t,S,r,i))break;break;case"CIMPictureMarker":if(ie(m,d,t,S,r,i))break;e.type==="CIMLineSymbol"&&(c=be(m)),Nt(m,d,t,S,r,n,i,c,f);break;case"CIMVectorMarker":if(ie(m,d,t,S,r,i))break;e.type==="CIMLineSymbol"&&(c=be(m)),Ct(m,d,t,S,r,i,n,c,f,l);break;default:le.error("Cannot analyze CIM layer",m.type)}}}function yt(e,o,t,r,i,n){const l=e.primitiveName,a=z(e.color),[s,c]=Y(r,l,o,null,null),f=P(JSON.stringify(e)+c).toString();n.push({type:"fill",templateHash:f,materialHash:s?()=>f:f,cim:e,materialOverrides:null,colorLocked:e.colorLocked,color:g(l,t,"Color",i,a,H),height:0,angle:0,offsetX:0,offsetY:0,scaleX:1,effects:o,applyRandomOffset:!1,sampleAlphaOnly:!0})}function ht(e,o,t,r,i,n,l){const a=e.primitiveName,s=e.tintColor?z(e.tintColor):{r:255,g:255,b:255,a:1},[c,f]=Y(r,a,o,null,null),p=P(JSON.stringify(e)+f).toString(),m=P(`${e.url}${JSON.stringify(e.colorSubstitutions)}`).toString();let u=C(e.scaleX);if("width"in e){const h=e.width;let y=1;const d=n.getResource(e.url);F(d)&&(y=d.width/d.height),u/=y*(e.height/h)}l.push({type:"fill",templateHash:p,materialHash:c?()=>m:m,cim:e,materialOverrides:null,colorLocked:e.colorLocked,effects:o,color:g(a,t,"TintColor",i,s,H),height:g(a,t,"Height",i,e.height),scaleX:g(a,t,"ScaleX",i,u),angle:g(a,t,"Rotation",i,C(e.rotation)),offsetX:g(a,t,"OffsetX",i,C(e.offsetX)),offsetY:g(a,t,"OffsetY",i,C(e.offsetY)),url:e.url,applyRandomOffset:!1,sampleAlphaOnly:!1})}function gt(e,o,t,r,i,n){var h;const l=["Rotation","OffsetX","OffsetY"],a=r.filter(y=>y.primitiveName!==e.primitiveName&&!l.includes(y.propertyName)),s=e.primitiveName,[c,f]=Y(r,s,o,null,null),p=P(JSON.stringify(e)+f).toString(),m=P(`${e.separation}${JSON.stringify(e.lineSymbol)}`).toString();let u={r:255,g:255,b:255,a:1};if(e.lineSymbol){const y=(h=e.lineSymbol)==null?void 0:h.symbolLayers.find(d=>d.type==="CIMSolidStroke");y&&(u=z(y.color))}n.push({type:"fill",templateHash:p,materialHash:c?K(m,t,a,i):m,cim:e,materialOverrides:a,colorLocked:e.colorLocked,effects:o,color:u,height:g(s,t,"Separation",i,e.separation),scaleX:1,angle:g(s,t,"Rotation",i,C(e.rotation)),offsetX:g(s,t,"OffsetX",i,C(e.offsetX)),offsetY:g(s,t,"OffsetY",i,C(e.offsetY)),applyRandomOffset:!1,sampleAlphaOnly:!0})}function dt(e,o,t,r,i,n){const l=e.primitiveName,[a,s]=Y(r,l,o,null,null),c=P(JSON.stringify(e)+s).toString();n.push({type:"fill",templateHash:c,materialHash:a?K(c,t,r,i):c,cim:e,materialOverrides:null,colorLocked:e.colorLocked,effects:o,color:{r:128,g:128,b:128,a:1},height:0,angle:0,offsetX:0,offsetY:0,scaleX:1,applyRandomOffset:!1,sampleAlphaOnly:!1})}function St(e,o,t,r,i,n,l,a){const s=e.primitiveName,c=z(e.color),f=e.width!==void 0?e.width:4,p=se(e.capStyle),m=ce(e.joinStyle),u=e.miterLimit,[h,y]=Y(r,s,o,null,null),d=P(JSON.stringify(e)+y).toString();let S,N;if(o&&o instanceof Array&&o.length>0){const b=o[o.length-1];if(b.type==="CIMGeometricEffectDashes"&&b.lineDashEnding==="NoConstraint"&&b.offsetAlongLine===null){const v=(o=[...o]).pop();S=v.dashTemplate,N=v.scaleDash}}n.push({type:"line",templateHash:d,materialHash:h?()=>d:d,cim:e,materialOverrides:null,isOutline:l,colorLocked:e.colorLocked,effects:o,color:g(s,t,"Color",i,c,H),width:g(s,t,"Width",i,f),cap:g(s,t,"CapStyle",i,p),join:g(s,t,"JoinStyle",i,m),miterLimit:g(s,t,"MiterLimit",i,u),referenceWidth:a,zOrder:fe(e.name),dashTemplate:S,scaleDash:N,sampleAlphaOnly:!0})}function vt(e,o,t,r,i,n,l,a){const s=P(`${e.url}${JSON.stringify(e.colorSubstitutions)}`).toString(),c=e.primitiveName,f=z(e.tintColor),p=e.width!==void 0?e.width:4,m=se(e.capStyle),u=ce(e.joinStyle),h=e.miterLimit,[y,d]=Y(r,c,o,null,null),S=P(JSON.stringify(e)+d).toString();n.push({type:"line",templateHash:S,materialHash:y?()=>s:s,cim:e,materialOverrides:null,isOutline:l,colorLocked:e.colorLocked,effects:o,color:g(c,t,"TintColor",i,f,H),width:g(c,t,"Width",i,p),cap:g(c,t,"CapStyle",i,m),join:g(c,t,"JoinStyle",i,u),miterLimit:g(c,t,"MiterLimit",i,h),referenceWidth:a,zOrder:fe(e.name),dashTemplate:null,scaleDash:!1,url:e.url,sampleAlphaOnly:!1})}function bt(e,o,t,r,i,n,l,a){const s=e.primitiveName,c=e.width!==void 0?e.width:4,f=se(e.capStyle),p=ce(e.joinStyle),m=e.miterLimit,[u,h]=Y(r,s,o,null,null),y=P(JSON.stringify(e)+h).toString();n.push({type:"line",templateHash:y,materialHash:u?K(y,t,r,i):y,cim:e,materialOverrides:null,isOutline:l,colorLocked:e.colorLocked,effects:o,color:{r:128,g:128,b:128,a:1},width:g(s,t,"Width",i,c),cap:g(s,t,"CapStyle",i,f),join:g(s,t,"JoinStyle",i,p),miterLimit:g(s,t,"MiterLimit",i,m),referenceWidth:a,zOrder:fe(e.name),dashTemplate:null,scaleDash:!1,sampleAlphaOnly:!1})}function ie(e,o,t,r,i,n){const l=e.markerPlacement;if(!l||l.type!=="CIMMarkerPlacementInsidePolygon")return!1;const a=l,s=Math.abs(a.stepX),c=Math.abs(a.stepY);if(s===0||c===0)return!0;const f=["Rotation","OffsetX","OffsetY"],p=r.filter(v=>v.primitiveName!==e.primitiveName&&!f.includes(v.propertyName)),m="url"in e?e.url:null,[u,h]=Y(r,a.primitiveName,o,null,null),y=P(JSON.stringify(e)+h).toString();let d,S,N=null;if(l.gridType==="Random"){const v=Ye(We),k=Math.max(Math.floor(v/s),1),X=Math.max(Math.floor(v/c),1);d=c*X,N=x=>x?x*X:0,S=k*s/d}else l.shiftOddRows?(d=2*c,N=v=>v?2*v:0,S=s/c*.5):(d=c,N=null,S=s/c);let b={r:255,g:255,b:255,a:1};return"tintColor"in e&&(b=z(e.tintColor)),n.push({type:"fill",templateHash:y,materialHash:u?K(y,t,p,i):y,cim:e,materialOverrides:p,colorLocked:e.colorLocked,effects:o,color:g(a.primitiveName,t,"TintColor",i,b,H),height:g(a.primitiveName,t,"StepY",i,d,N),scaleX:S,angle:g(a.primitiveName,t,"GridAngle",i,a.gridAngle),offsetX:g(a.primitiveName,t,"OffsetX",i,C(a.offsetX)),offsetY:g(a.primitiveName,t,"OffsetY",i,C(a.offsetY)),url:m,applyRandomOffset:l.gridType==="Random",sampleAlphaOnly:!m}),!0}function Nt(e,o,t,r,i,n,l,a,s){var w;const c=e.primitiveName,f=C(e.size);let p=C(e.scaleX);const m=C(e.rotation),u=C(e.offsetX),h=C(e.offsetY),y=e.tintColor?z(e.tintColor):{r:255,g:255,b:255,a:1},d=P(`${e.url}${JSON.stringify(e.colorSubstitutions)}${JSON.stringify(e.animatedSymbolProperties)}`).toString(),S=Pe(e.markerPlacement,r,t,i),N=wt(e.animatedSymbolProperties,r,t,i),[b,v]=Y(r,c,o,S,N),k=P(JSON.stringify(e)+v).toString(),X=(w=e.anchorPoint)!=null?w:{x:0,y:0};if("width"in e){const O=e.width;let M=1;const L=n.getResource(e.url);F(L)&&(M=L.width/L.height),p/=M*(f/O)}function x(O,M){return Ce(N,O,M)}const $=e.animatedSymbolProperties&&e.animatedSymbolProperties.randomizeStartTime===!0?(O,M,L,J)=>{const E=at(J),T=x(O,M);return d+`-MATERIALGROUP(${E})-ASP(${JSON.stringify(T)})`}:b?(O,M)=>{const L=x(O,M);return d+`-ASP(${JSON.stringify(L)})`}:d;l.push({type:"marker",templateHash:k,materialHash:$,cim:e,materialOverrides:null,colorLocked:e.colorLocked,effects:o,scaleSymbolsProportionally:!1,alignment:a,size:g(c,t,"Size",i,f),scaleX:g(c,t,"ScaleX",i,p),rotation:g(c,t,"Rotation",i,m),offsetX:g(c,t,"OffsetX",i,u),offsetY:g(c,t,"OffsetY",i,h),color:g(c,t,"TintColor",i,y,H),anchorPoint:{x:X.x,y:-X.y},isAbsoluteAnchorPoint:e.anchorPointUnits!=="Relative",outlineColor:{r:0,g:0,b:0,a:0},outlineWidth:0,frameHeight:0,rotateClockwise:e.rotateClockwise,referenceSize:s,sizeRatio:1,markerPlacement:S,url:e.url,animatedSymbolProperties:N})}function Ct(e,o,t,r,i,n,l,a,s,c){const f=e.markerGraphics;if(!f)return;let p=0;if(e.scaleSymbolsProportionally){const u=e.frame;u&&(p=u.ymax-u.ymin)}const m=Pe(e.markerPlacement,r,t,i);for(const u of f)if(u){const h=u.symbol;if(!h)continue;switch(h.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":kt(e,o,m,null,u,r,t,i,n,l,a,s,p,c);break;case"CIMTextSymbol":Ot(e,o,m,u,t,r,i,n,a,s,p)}}}function Ot(e,o,t,r,i,n,l,a,s,c,f){const p=[];j.findApplicableOverrides(r,n,p);const m=r.geometry;if(!("x"in m)||!("y"in m))return;const u=r.symbol,h=ut(u),y=mt(u.fontStyleName),d=Me(u.fontFamilyName);u.font={family:d,decoration:h,...y};const S=e.frame,N=m.x-.5*(S.xmin+S.xmax),b=m.y-.5*(S.ymin+S.ymax),v=e.size/f,k=e.primitiveName,X=C(u.height)*v,x=C(u.angle),$=C(e.offsetX)+(C(u.offsetX)+N)*v,w=C(e.offsetY)+(C(u.offsetY)+b)*v,O=z(R.getFillColor(u));let M=z(R.getStrokeColor(u)),L=R.getStrokeWidth(u);L||(M=z(R.getFillColor(u.haloSymbol)),L=u.haloSize*v);const[J,E]=Y(n,k,o,t,null),T=JSON.stringify(e.effects)+Number(e.colorLocked)+JSON.stringify(e.anchorPoint)+e.anchorPointUnits+JSON.stringify(e.markerPlacement),G=P(JSON.stringify(r)+T+E).toString();let I=g(r.primitiveName,i,"TextString",l,r.textString,Ie,u.textCase);if(I==null)return;const{fontStyleName:B}=u,W=d+(B?"-"+B.toLowerCase():"-regular"),D=W;typeof I=="string"&&I.includes("[")&&u.fieldMap&&(I=Xe(u.fieldMap,I,u.textCase)),a.push({type:"text",templateHash:G,materialHash:J||typeof I=="function"||I.match(/\[(.*?)\]/)?(A,Q,_)=>D+"-"+Ce(I,A,Q,_):D+"-"+P(I),cim:u,materialOverrides:null,colorLocked:e.colorLocked,effects:o,alignment:s,anchorPoint:{x:e.anchorPoint?e.anchorPoint.x:0,y:e.anchorPoint?e.anchorPoint.y:0},isAbsoluteAnchorPoint:e.anchorPointUnits!=="Relative",fontName:W,decoration:h,weight:g(k,i,"Weight",l,y.weight),style:g(k,i,"Size",l,y.style),size:g(k,i,"Size",l,X),angle:g(k,i,"Rotation",l,x),offsetX:g(k,i,"OffsetX",l,$),offsetY:g(k,i,"OffsetY",l,w),horizontalAlignment:ct(u.horizontalAlignment),verticalAlignment:ft(u.verticalAlignment),text:I,color:O,outlineColor:M,outlineSize:L,referenceSize:c,sizeRatio:1,markerPlacement:t})}function kt(e,o,t,r,i,n,l,a,s,c,f,p,m,u){var N;const h=i.symbol,y=h.symbolLayers;if(!y)return;if(u)return void Ne(e,o,t,r,i,l,n,a,s,c,f,p,m);let d=y.length;if(Lt(y))return void Mt(e,o,t,r,i,y,n,l,a,s,f,p,m);const S=Se.applyEffects(h.effects,i.geometry,c.geometryEngine);if(S)for(;d--;){const b=y[d];if(b&&b.enable!==!1)switch(b.type){case"CIMSolidFill":case"CIMSolidStroke":{const v=Se.applyEffects(b.effects,S,c.geometryEngine),k=Oe(v);if(!k)continue;const[X,x,$]=ke(k,e.frame,e.size,e.anchorPoint,e.anchorPointUnits!=="Relative"),w=b.type==="CIMSolidFill",O={type:"sdf",geom:v,asFill:w},M=e.primitiveName,L=(N=C(e.size))!=null?N:10,J=C(e.rotation),E=C(e.offsetX),T=C(e.offsetY),G=b.path,I=b.primitiveName,B=z(w?R.getFillColor(b):R.getStrokeColor(b)),W=w?{r:0,g:0,b:0,a:0}:z(R.getStrokeColor(b)),D=R.getStrokeWidth(b);if(!w&&!D)break;let A=!1,Q="";for(const U of n)U.primitiveName!==I&&U.primitiveName!==M||(U.value!==void 0?Q+=`-${U.primitiveName}-${U.propertyName}-${JSON.stringify(U.value)}`:U.valueExpressionInfo&&(A=!0));F(o)&&typeof o=="function"&&(A=!0);const _=JSON.stringify({...e,markerGraphics:null}),ue=P(JSON.stringify(O)+G).toString(),we={type:"marker",templateHash:P(JSON.stringify(i)+JSON.stringify(b)+_+Q).toString(),materialHash:A?()=>ue:ue,cim:O,materialOverrides:null,colorLocked:e.colorLocked,effects:o,scaleSymbolsProportionally:e.scaleSymbolsProportionally,alignment:f,anchorPoint:{x,y:$},isAbsoluteAnchorPoint:!1,size:g(e.primitiveName,l,"Size",a,L),rotation:g(e.primitiveName,l,"Rotation",a,J),offsetX:g(e.primitiveName,l,"OffsetX",a,E),offsetY:g(e.primitiveName,l,"OffsetY",a,T),scaleX:1,frameHeight:m,rotateClockwise:e.rotateClockwise,referenceSize:p,sizeRatio:X,color:g(I,l,"Color",a,B,H),outlineColor:g(I,l,"Color",a,W,H),outlineWidth:g(I,l,"Width",a,D),markerPlacement:t,animatedSymbolProperties:r,path:G};s.push(we);break}default:Ne(e,o,t,r,i,l,n,a,s,c,f,p,m)}}}function Mt(e,o,t,r,i,n,l,a,s,c,f,p,m){const u=i.geometry,h=n[0],y=n[1],d=Oe(u);if(!d)return;const[S,N,b]=ke(d,e.frame,e.size,e.anchorPoint,e.anchorPointUnits!=="Relative"),v={type:"sdf",geom:u,asFill:!0},k=e.primitiveName,X=C(e.size),x=C(e.rotation),$=C(e.offsetX),w=C(e.offsetY),O=y.path,M=y.primitiveName,L=h.primitiveName,J=z(R.getFillColor(y)),E=z(R.getStrokeColor(h)),T=R.getStrokeWidth(h);let G=!1,I="";for(const A of l)A.primitiveName!==M&&A.primitiveName!==L&&A.primitiveName!==k||(A.value!==void 0?I+=`-${A.primitiveName}-${A.propertyName}-${JSON.stringify(A.value)}`:A.valueExpressionInfo&&(G=!0));const B=JSON.stringify({...e,markerGraphics:null}),W=P(JSON.stringify(v)+O).toString(),D={type:"marker",templateHash:P(JSON.stringify(i)+JSON.stringify(y)+JSON.stringify(h)+B+I).toString(),materialHash:G?()=>W:W,cim:v,materialOverrides:null,colorLocked:e.colorLocked,effects:o,scaleSymbolsProportionally:e.scaleSymbolsProportionally,alignment:f,anchorPoint:{x:N,y:b},isAbsoluteAnchorPoint:!1,size:g(e.primitiveName,a,"Size",s,X),rotation:g(e.primitiveName,a,"Rotation",s,x),offsetX:g(e.primitiveName,a,"OffsetX",s,$),offsetY:g(e.primitiveName,a,"OffsetY",s,w),scaleX:1,frameHeight:m,rotateClockwise:e.rotateClockwise,referenceSize:p,sizeRatio:S,color:g(M,a,"Color",s,J,H),outlineColor:g(L,a,"Color",s,E,H),outlineWidth:g(L,a,"Width",s,T),markerPlacement:t,path:O,animatedSymbolProperties:r};c.push(D)}function Ne(e,o,t,r,i,n,l,a,s,c,f,p,m){const u=Pt(e,i);let h=[];const y=["Rotation","OffsetX","OffsetY"];h=l.filter(O=>O.primitiveName!==e.primitiveName||!y.includes(O.propertyName));let d="";for(const O of l)O.value!==void 0&&(d+=`-${O.primitiveName}-${O.propertyName}-${JSON.stringify(O.value)}`);const[S,N,b]=R.getTextureAnchor(u,c),v=e.primitiveName,k=C(e.rotation),X=C(e.offsetX),x=C(e.offsetY),$=P(JSON.stringify(u)+d).toString(),w={type:"marker",templateHash:$,materialHash:h.length>0||F(o)&&typeof o=="function"?K($,n,h,a):$,cim:u,materialOverrides:h,colorLocked:e.colorLocked,effects:o,scaleSymbolsProportionally:e.scaleSymbolsProportionally,alignment:f,anchorPoint:{x:S,y:N},isAbsoluteAnchorPoint:!1,size:e.size,rotation:g(v,n,"Rotation",a,k),offsetX:g(v,n,"OffsetX",a,X),offsetY:g(v,n,"OffsetY",a,x),color:{r:255,g:255,b:255,a:1},outlineColor:{r:0,g:0,b:0,a:0},outlineWidth:0,scaleX:1,frameHeight:m,rotateClockwise:e.rotateClockwise,referenceSize:p,sizeRatio:b/Ae(e.size),markerPlacement:t,animatedSymbolProperties:r};s.push(w)}function Pt(e,o){return{type:e.type,enable:!0,name:e.name,colorLocked:e.colorLocked,primitiveName:e.primitiveName,anchorPoint:e.anchorPoint,anchorPointUnits:e.anchorPointUnits,offsetX:0,offsetY:0,rotateClockwise:e.rotateClockwise,rotation:0,size:e.size,billboardMode3D:e.billboardMode3D,depth3D:e.depth3D,frame:e.frame,markerGraphics:[o],scaleSymbolsProportionally:e.scaleSymbolsProportionally,respectFrame:e.respectFrame,clippingPath:e.clippingPath}}function fe(e){if(e&&e.indexOf("Level_")===0){const o=parseInt(e.substr(6),10);if(!isNaN(o))return o}return 0}function H(e){if(!e||e.length===0)return null;const o=new He(e).toRgba();return{r:o[0],g:o[1],b:o[2],a:o[3]}}function g(e,o,t,r,i,n,l){const a=o[e];if(a){const s=a[t];if(typeof s=="string"||typeof s=="number"||s instanceof Array)return n?n.call(null,s,l):s;if(s!=null&&s instanceof V)return(c,f,p)=>{let m=Z(s,c,{$view:p},r.geometryType,f);return m!==null&&n&&(m=n.call(null,m,l)),m!==null?m:i}}return i}function me(e){return e&&e.charAt(0).toLowerCase()+e.substr(1)}function xt(e,o,t,r){for(const i of o)if(i.valueExpressionInfo){const n=t[i.primitiveName]&&t[i.primitiveName][i.propertyName];n instanceof V&&(i.fn=(l,a,s)=>Z(n,l,{$view:s},r.geometryType,a))}return(i,n,l)=>{for(const s of o)s.fn&&(s.value=s.fn(i,n,l));const a=[];for(let s of e){const c=s==null?void 0:s.primitiveName;if(c){let f=!1;for(const p of o)if(p.primitiveName===c){const m=me(p.propertyName);p.value!=null&&p.value!==s[m]&&(f||(s=ae(s),f=!0),s[m]=p.value)}}a.push(s)}return a}}function Pe(e,o,t,r){const i=[];if(j.findApplicableOverrides(e,o,i),i.length===0)return e;for(const n of i)if(n.valueExpressionInfo){const l=t[n.primitiveName]&&t[n.primitiveName][n.propertyName];l instanceof V&&(n.fn=(a,s,c)=>Z(l,a,{$view:c},r.geometryType,s))}return(n,l,a)=>{for(const f of i)f.fn&&(f.value=f.fn(n,l,a));const s=ae(e),c=e.primitiveName;for(const f of i)if(f.primitiveName===c){const p=me(f.propertyName);f.value!=null&&f.value!==s[p]&&(s[p]=f.value)}return s}}function wt(e,o,t,r){const i=[];if(j.findApplicableOverrides(e,o,i),i.length===0)return e;for(const n of i)if(n.valueExpressionInfo){const l=t[n.primitiveName]&&t[n.primitiveName][n.propertyName];l instanceof V&&(n.fn=(a,s,c)=>Z(l,a,{$view:c},r.geometryType,s))}return(n,l,a)=>{for(const f of i)f.fn&&(f.value=f.fn(n,l,a));const s=ae(e),c=e.primitiveName;for(const f of i)if(f.primitiveName===c){const p=me(f.propertyName);f.value!=null&&f.value!==s[p]&&(s[p]=f.value)}return s}}function K(e,o,t,r){for(const i of t)if(i.valueExpressionInfo){const n=o[i.primitiveName]&&o[i.primitiveName][i.propertyName];n instanceof V&&(i.fn=(l,a,s)=>Z(n,l,{$view:s},r.geometryType,a))}return(i,n,l)=>{for(const a of t)a.fn&&(a.value=a.fn(i,n,l));return P(e+j.buildOverrideKey(t)).toString()}}function Yt(e,o){if(!o||o.length===0)return e;const t=JSON.parse(JSON.stringify(e));return j.applyOverrides(t,o),t}function Y(e,o,t,r,i){let n=!1,l="";for(const a of e)a.primitiveName===o&&(a.value!==void 0?l+=`-${a.primitiveName}-${a.propertyName}-${JSON.stringify(a.value)}`:a.valueExpressionInfo&&(n=!0));return F(t)&&typeof t=="function"&&(n=!0),F(r)&&typeof r=="function"&&(n=!0),F(i)&&typeof i=="function"&&(n=!0),[n,l]}function xe(e,o,t){if(e&&o)switch(e.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":{const r=e.symbolLayers;if(!r)return;for(const i of r)switch($t(i,o,t),i.type){case"CIMPictureFill":case"CIMHatchFill":case"CIMGradientFill":case"CIMPictureStroke":case"CIMGradientStroke":case"CIMCharacterMarker":case"CIMPictureMarker":"url"in i&&i.url&&t.push(o.fetchResource(i.url,null));break;case"CIMVectorMarker":{const n=i.markerGraphics;if(!n)continue;for(const l of n)if(l){const a=l.symbol;a&&xe(a,o,t)}}}}}}const Lt=e=>e&&e.length===2&&e[0].enable&&e[1].enable&&e[0].type==="CIMSolidStroke"&&e[1].type==="CIMSolidFill"&&!e[0].effects&&!e[1].effects;let q;function $t(e,o,t){if(!(!e.effects||F(o.geometryEngine))){if(q)return void t.push(q);ze(e.effects)&&(q=Re(),t.push(q),q.then(r=>o.geometryEngine=r))}}export{Ht as Y,Z as a,Rt as b,nt as e,Se as f,Jt as n,at as o,qe as r,Yt as s};
